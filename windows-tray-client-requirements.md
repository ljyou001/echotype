# CapsWriter Windows 托盘客户端需求说明

## 1. 背景
CapsWriter-Offline 现有客户端以 CLI 形式运行，通过全局快捷键唤起麦克风录音，将音频流推送至本地服务器进行离线识别。为提升 Windows 用户体验，需要提供常驻托盘的可视化客户端，便于快捷配置和状态反馈，同时保持现有语音识别流程与服务器交互逻辑不变。

## 2. 建设目标
- 提供在 Windows 10/11 上常驻的托盘程序，替代现有命令行交互。
- 支持一键启动/停止监听、快速修改核心配置（如监听按键、模式切换、服务器地址）。
- 在不影响识别准确率的前提下，最小化系统资源占用，并确保程序稳定运行。

## 3. 范围定义
### 3.1 涉及内容
- 托盘图标及右键菜单交互。
- 基于现有核心逻辑（`core_client.py` 及 `util` 模块）的封装与调用。
- GUI 配置入口及配置持久化。
- 运行状态提示（图标、气泡通知、日志）。
- 客户端进程生命周期管理（自启动、异常重启策略可选）。

### 3.2 不包含内容
- 语音识别算法与模型的更改。
- 服务器端功能改动。
- 全新 UI 桌面窗口（仅托盘及必要的设置对话框）。
- 自动更新能力（可列入后续需求）。

## 4. 角色与使用场景
- **普通用户**：希望在 Windows 上快速启停监听，并调整热键。
- **高级用户**：需要修改服务器地址、端口、热词文件路径等高级配置。
- **维护人员**：通过日志与状态信息定位问题，辅助排查。

## 5. 运行环境
- 操作系统：Windows 10/11 x64。
- 依赖组件：现有 Python 运行时及依赖库，VC++ 运行库已在安装指引中涵盖。
- 硬件要求：与现有客户端一致（≥4GB 内存，麦克风设备可用）。

## 6. 功能性需求
### 6.1 托盘驻留与图标状态
- 程序启动后最小化到系统托盘，仅显示图标，无控制台窗口。
- 图标需根据监听状态动态切换：未连接、待机、录音中、错误告警等至少 4 种状态。
- 鼠标悬停时显示当前状态摘要（如“已连接 • CapsLock 按住说话”）。

### 6.2 右键菜单与交互项
- **立即开始/停止监听**：显式触发 `core_client` 中的监听流程或停止任务。
- **选择监听模式**：切换 `hold_mode` 与点击模式（复用 `ClientConfig.hold_mode`）。
- **设置监听按键…**：打开配置对话框，允许用户从快捷键列表中选择或录制自定义按键。
- **打开设置…**：进入完整设置界面（详见 6.4）。
- **查看日志…**：打开日志文件所在目录，便于排查。
- **启动服务器**（可选）：检测本地 server 可执行文件，允许一键拉起，若不可用则置灰。
- **退出**：安全关闭麦克风流、WebSocket，并退出托盘。

### 6.3 后台连接与状态管理
- 托盘程序启动时尝试连接服务器（默认 `127.0.0.1:6016`），失败时重试并反馈错误状态。
- 监听核心逻辑复用 `core_client` 的事件循环，需在 GUI 主线程与 asyncio 之间做好线程/协程桥接。
- 支持热词、配置文件的自动更新监听（沿用 `observe_hot` 函数）。

### 6.4 配置界面与持久化
- 设置界面采用简单对话框（Tabs 或分组）展示关键配置：
  - 服务器：地址、端口、超时、自动重连间隔。
  - 快捷键：当前组合键、模式（按住/点按）、是否抑制原按键、恢复按键设置。
  - 音频：麦克风设备列表选择、保存音频开关、文件命名长度。
  - 输出：粘贴模式、剪贴板恢复、识别结果显示偏好。
  - 热词/资源：热词文件开关与路径、模型路径只读展示。
- 配置保存到用户 AppData（例如 `%APPDATA%\CapsWriter\client.json`），首次运行若无配置则拷贝默认值。
- 修改配置后即时生效，必要时提示需重启监听。

### 6.5 通知与提示
- 关键状态变化（首次连接成功、服务器断开、识别完成、错误）通过托盘气泡通知，并可在设置中关闭通知。
- 支持错误信息写入日志，同时保留一个系统通知（例如连接失败后提供“检查服务器设置”操作）。

### 6.6 日志与诊断
- 将现有控制台输出迁移为滚动日志文件（按日期切分，默认 `%LOCALAPPDATA%\CapsWriter\logs`）。
- 在设置界面中提供日志级别选项（INFO/DEBUG）。

### 6.7 启动与退出流程
- 支持“启动时最小化到托盘”选项（默认开启）。
- 支持“登录时自动启动”选项（写入启动项，需在 UI 提示用户并可撤销）。
- 退出时确保停止音频流、终止后台任务、关闭 WebSocket，避免残留进程。

### 6.8 文件与热词同步
- 保持对 `hot-*.txt`、`keywords.txt` 的文件观察机制，当文件更新时托盘提示并加载最新热词。
- 若文件路径不可用，向用户提示并记录日志。

### 6.9 语音识别任务控制
- 录音流程沿用 `send_audio`、`recv_result` 等现有逻辑。
- 托盘需在录音开始/结束时更新状态并可选提示。
- 粘贴/输出行为（`paste`、`restore_clip`）保持兼容，必要时提供开关。

### 6.10 异常处理
- 捕获 `keyboard`、`sounddevice` 等库抛出的常见异常，提示用户检查权限或设备。
- 若事件循环出现未捕获异常，记录日志并以弹窗或通知方式提示重启客户端。

## 7. 非功能性需求
- **性能**：常驻空闲 CPU 占用 <5%，内存占用 <250MB（含模型缓存）。
- **响应性**：快捷键触发至开始录音延迟 ≤100ms；识别结果到粘贴输出保持与原实现一致。
- **稳定性**：长时间运行（≥8 小时）不得出现资源泄漏或崩溃；断网后自动重连机制需在 5 秒内重试。
- **可用性**：设置界面遵循 Windows 常规交互；提供中文界面与提示。
- **可维护性**：代码结构应将 GUI 层与核心逻辑分离，便于后续升级或替换 GUI 框架。

## 8. 配置项与默认值（初稿）
保持 `config.ClientConfig` 中现有字段，新增或调整：
- `auto_startup`: bool，登录时自动启动。
- `show_notifications`: bool，是否显示系统通知。
- `log_level`: str，日志级别。
- `audio_input_device`: str，首选输入设备 ID。
- `config_path`: str，记录当前配置文件路径（只读显示）。

## 9. 技术实现建议
- GUI/托盘框架优先考虑 `pystray` + `Pillow` 或 `PySide6`（若需更完整 GUI）。
- 与 `core_client` 的协作通过后台线程运行 asyncio 事件循环，并利用线程安全队列与 GUI 通信。
- 使用 `asyncio` + `watchdog` 保留热词文件监听。
- 打包方案沿用 PyInstaller，使用 `--noconsole`、`--icon` 等参数生成 `CapsWriterTray.exe`。
- 托盘图标建议使用单色 SVG/ICO，并提供多分辨率资源。

## 10. 安装与发布
- 提供压缩包或安装程序两种分发方式：
  - 免安装绿色版：包含托盘程序、所需 DLL、模型文件目录说明。
  - 安装版（可选）：写入开始菜单、启动项，提供卸载入口。
- 安装完成后引导用户导入模型文件（若未包含）。

## 11. 测试与验收要点
- 功能测试：快捷键触发、菜单操作、设置修改、日志生成、热词更新。
- 兼容性测试：不同 Windows 版本、管理员/非管理员权限、不同键盘布局。
- 稳定性测试：连续运行、断开网络、服务器重启、麦克风切换。
- 打包测试：签名与杀毒误报评估；检查缺失依赖（VC++、音频驱动）。

## 12. 风险与待定事项
- 托盘程序与 asyncio 主循环并存可能引入线程安全风险，需要明确的队列通信设计。
- `keyboard` 库在部分环境权限受限，需要评估是否提供备用的热键实现（如 win32 API）。
- 自动启动涉及注册表写入，需要提示用户风险并获取确认。
- 若未来需要跨平台 GUI，建议在当前阶段保持核心逻辑解耦。

